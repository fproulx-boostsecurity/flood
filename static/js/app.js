// JavaScript for the Flood poetry generator

document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateBtn');
    const shareBtn = document.getElementById('shareBtn');
    const poemContent = document.querySelector('.poem-content');

    // Generate new poem
    generateBtn.addEventListener('click', async function() {
        try {
            // Add loading state
            generateBtn.classList.add('loading');
            generateBtn.disabled = true;

            // Fetch new poem from API
            const response = await fetch('/api/poem');
            const poem = await response.json();

            // Update the poem content
            updatePoemDisplay(poem);

            // Remove loading state
            setTimeout(() => {
                generateBtn.classList.remove('loading');
                generateBtn.disabled = false;
            }, 500);

        } catch (error) {
            console.error('Error generating poem:', error);
            showFeedback('Error generating poem. Please try again.', 'error');
            
            // Remove loading state
            generateBtn.classList.remove('loading');
            generateBtn.disabled = false;
        }
    });

    // Copy poem to clipboard
    shareBtn.addEventListener('click', function() {
        const poemTitle = document.querySelector('.poem-title');
        const poemLines = document.querySelectorAll('.poem-line');
        
        if (poemTitle && poemLines.length > 0) {
            let poemText = poemTitle.textContent + '\n\n';
            poemLines.forEach(line => {
                poemText += line.textContent + '\n';
            });
            poemText += '\n--- Generated by Flood Poetry Generator ---';

            // Copy to clipboard
            navigator.clipboard.writeText(poemText).then(function() {
                showFeedback('Poem copied to clipboard!', 'success');
            }).catch(function(err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = poemText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showFeedback('Poem copied to clipboard!', 'success');
            });
        }
    });

    // Update poem display with animation
    function updatePoemDisplay(poem) {
        const poemTitle = document.querySelector('.poem-title');
        const poemText = document.querySelector('.poem-text');

        if (poemTitle && poemText && poem) {
            // Fade out current content
            poemContent.style.opacity = '0';
            poemContent.style.transform = 'translateY(20px)';

            setTimeout(() => {
                // Update content
                poemTitle.textContent = poem.title;
                poemText.innerHTML = '';
                
                poem.lines.forEach(line => {
                    const p = document.createElement('p');
                    p.className = 'poem-line';
                    p.textContent = line;
                    poemText.appendChild(p);
                });

                // Fade in new content
                poemContent.style.opacity = '1';
                poemContent.style.transform = 'translateY(0)';
            }, 300);
        }
    }

    // Show feedback messages
    function showFeedback(message, type = 'success') {
        const feedback = document.createElement('div');
        feedback.className = `copy-feedback ${type}`;
        feedback.textContent = message;
        
        if (type === 'error') {
            feedback.style.background = '#e53e3e';
        }
        
        document.body.appendChild(feedback);

        // Remove after 3 seconds
        setTimeout(() => {
            feedback.style.animation = 'slideInRight 0.3s ease-out reverse';
            setTimeout(() => {
                document.body.removeChild(feedback);
            }, 300);
        }, 3000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        // Press 'G' to generate new poem
        if (event.key.toLowerCase() === 'g' && !event.ctrlKey && !event.metaKey) {
            if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                event.preventDefault();
                generateBtn.click();
            }
        }
        
        // Press 'C' to copy poem
        if (event.key.toLowerCase() === 'c' && !event.ctrlKey && !event.metaKey) {
            if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                event.preventDefault();
                shareBtn.click();
            }
        }
    });

    // Add smooth transition styles
    if (poemContent) {
        poemContent.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    }
});